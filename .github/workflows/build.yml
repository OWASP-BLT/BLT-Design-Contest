name: Build & Deploy Design Showcase

on:
  # Rebuild on every push to main
  push:
    branches:
      - main

  # Rebuild whenever a design-submission issue is opened, edited, or labelled
  issues:
    types: [opened, edited, labeled, unlabeled, closed, reopened, deleted]

  # Rebuild when a comment is added, edited, or deleted on an issue
  issue_comment:
    types: [created, edited, deleted]

  # Allow manual triggering from the Actions tab
  workflow_dispatch:

  # Rebuild every 2 hours to keep reaction counts fresh (GitHub Actions has no native reaction trigger)
  schedule:
    - cron: "0 */2 * * *"

permissions:
  contents: write   # needed to commit index.html back to main
  issues: write     # needed to create/apply labels and read reactions
  pages: write      # needed to deploy to GitHub Pages
  id-token: write   # needed for OIDC token used by deploy-pages

jobs:
  build-and-deploy:
    name: Build showcase & deploy to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure design-submission label exists and label open [Design] issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labelName = 'design-submission';

            // Create the label if it doesn't exist
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner, repo,
                  name: labelName,
                  color: 'e10101',
                  description: 'Design contest submission',
                });
                console.log(`Created label: ${labelName}`);
              } else {
                throw e;
              }
            }

            // Apply the label to any open [Design] issues that are missing it
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: 'open', per_page: 100,
            });
            for (const issue of issues) {
              const title = issue.title || '';
              const hasLabel = issue.labels.some(l => l.name === labelName);
              if (title.startsWith('[Design]') && !hasLabel) {
                await github.rest.issues.addLabels({
                  owner, repo,
                  issue_number: issue.number,
                  labels: [labelName],
                });
                console.log(`Labelled issue #${issue.number}: ${title}`);
              }
            }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate index.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python scripts/build_showcase.py

      - name: Commit updated index.html to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cp index.html /tmp/generated_index.html
          git fetch origin main
          git checkout -f origin/main
          cp /tmp/generated_index.html index.html
          git add index.html
          if git diff --cached --quiet; then
            echo "No changes to index.html -- skipping commit."
            exit 0
          fi
          git commit -m "chore: rebuild showcase [skip ci]"
          git push origin HEAD:main

      - name: Prepare deployment directory
        run: |
          mkdir /tmp/deploy
          cp index.html _config.yml /tmp/deploy/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: /tmp/deploy

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
