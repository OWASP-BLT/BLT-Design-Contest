name: Build & Deploy Design Showcase

on:
  # Rebuild on every push to main
  push:
    branches:
      - main

  # Rebuild whenever a design-submission issue is opened, edited, or labelled
  issues:
    types: [opened, edited, labeled, unlabeled, closed, reopened, deleted]

  # Rebuild when a comment is added, edited, or deleted on an issue
  issue_comment:
    types: [created, edited, deleted]

  # Allow manual triggering from the Actions tab
  workflow_dispatch:

  # Rebuild every 2 hours to keep reaction counts fresh (GitHub Actions has no native reaction trigger)
  schedule:
    - cron: "0 */2 * * *"

permissions:
  contents: write   # needed to commit HTML files back to main
  issues: write     # needed to create/apply labels and read reactions
  pages: write      # needed to deploy to GitHub Pages
  id-token: write   # needed for OIDC token used by deploy-pages

# Only one deployment runs at a time; a newer run cancels any in-progress one.
# This prevents concurrent git pushes from failing with a non-fast-forward error
# and then skipping the Pages deployment step.
concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build showcase & deploy to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure contest labels exist and auto-label open issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // All labels that need to exist, plus the title prefix used to auto-apply them
            const contestLabels = [
              { name: 'design-submission',  color: 'e10101', description: 'BLT App Redesign submission',  titlePrefix: '[Design]'   },
              { name: 'logo-submission',    color: 'a855f7', description: 'BLT Logo Contest submission',  titlePrefix: '[Logo]'     },
              { name: 'homepage-submission',color: '3b82f6', description: 'BLT Homepage Design submission', titlePrefix: '[Homepage]' },
              { name: 'winner',             color: 'f59e0b', description: 'Contest winner',               titlePrefix: null         },
            ];

            // Ensure each label exists
            for (const lbl of contestLabels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: lbl.name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner, repo,
                    name: lbl.name,
                    color: lbl.color,
                    description: lbl.description,
                  });
                  console.log(`Created label: ${lbl.name}`);
                } else {
                  throw e;
                }
              }
            }

            // Auto-apply contest labels to open issues that are missing them
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: 'open', per_page: 100,
            });
            for (const issue of issues) {
              const title = issue.title || '';
              for (const lbl of contestLabels) {
                if (!lbl.titlePrefix) continue;
                const hasLabel = issue.labels.some(l => l.name === lbl.name);
                if (title.startsWith(lbl.titlePrefix) && !hasLabel) {
                  await github.rest.issues.addLabels({
                    owner, repo,
                    issue_number: issue.number,
                    labels: [lbl.name],
                  });
                  console.log(`Labelled issue #${issue.number} with '${lbl.name}': ${title}`);
                }
              }
            }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate showcase HTML pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python scripts/build_showcase.py

      - name: Prepare deployment directory
        run: |
          mkdir /tmp/deploy
          cp *.html _config.yml /tmp/deploy/
          touch /tmp/deploy/.nojekyll

      - name: Commit updated HTML files to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Stash all generated HTML files
          cp index.html /tmp/generated_index.html
          for f in *.html; do
            [ "$f" != "index.html" ] && cp "$f" "/tmp/generated_${f}"
          done
          git fetch origin main
          git checkout -f origin/main
          # Restore generated files
          cp /tmp/generated_index.html index.html
          for f in /tmp/generated_*.html; do
            name="${f#/tmp/generated_}"
            cp "$f" "$name"
          done
          git add *.html
          if git diff --cached --quiet; then
            echo "No changes to HTML files -- skipping commit."
            exit 0
          fi
          git commit -m "chore: rebuild showcase [skip ci]"
          git push origin HEAD:main || echo "Push to main failed (possible concurrent push); pages will still be deployed."

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: /tmp/deploy

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
